<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Server Modules &bull; shinypod</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">shinypod</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/ijlyttle/shinypod">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Server Modules</h1>
                        <h4 class="author">Ian Lyttle &amp; Alex Shum</h4>
            
            <h4 class="date">2016-12-04</h4>
          </div>

    
    
<div class="contents">
<p>This vignette derives from the RStudio <a href="http://shiny.rstudio.com/articles/modules.html">article on Shiny modules</a>.</p>
<div id="structure-of-a-server-module" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#structure-of-a-server-module" class="anchor"> </a></body></html>Structure of a server module</h2>
<p>Within a server-module function, we keep a certain order of elements within the module. This order was determined by looking over the shoulders at Andee Kaplan and Eric Hare&rsquo;s shiny code (thanks to both!).</p>
<ol style="list-style-type: decimal"><li><p><strong>Formals</strong> By definition these come first.</p></li>
<li><p><strong>Reactives</strong> We arrange the reactives so that reactives that are depended-upon by other reactives are placed <em>above</em> the reactives that &ldquo;do the depending&rdquo;. Reactives that validate data passed-in by the formals are put at the beginning. Keep in mind that code within reactives are called only on demand - if something downstream calls the reactive.</p></li>
<li><p><strong>Observers</strong> Observers are always called if anything being observed changes. This is a handy place to put any code that changes the UI. This might be code to update an input, or it might be some <code>shinyjs</code> code to show or hide inputs.</p></li>
<li><p><strong>Outputs</strong> One thing to keep in mind about outputs is that the code is run <strong>only</strong> if the output is visible in the UI. This is why it can be useful to put code that <em>needs</em> to run into observers.</p></li>
<li><p><strong>Return value</strong> We are still figuring this one out. For something like a dygraph, it will ultimately be an output; perhaps you expect it to be returned as an output. However, because a dygraph can be customized, it can be useful to return the dygraph as a reactive, allowing you to customize it and put it into an output yourself.</p></li>
</ol><div id="formals" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#formals" class="anchor"> </a></body></html>Formals</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dygraph_server &lt;-<span class="st"> </span>function(
  input, output, session,
  data)</code></pre></div>
<p>The first three arguments are the standard server arguments: <code>input</code>, <code>output</code>, and <code>session</code>.</p>
<p>Any additional arguments are passed from the server when <code>callModule</code> is invoked. By putting some extra logic in to the reactive that validates the data, we can allow additional arguments to be static or reactive.</p>
<p>In this case, we expect <code>data</code> to be either:</p>
<ul><li>a data frame</li>
<li>a reactive that returns a data frame</li>
</ul></div>
<div id="reactives" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#reactives" class="anchor"> </a></body></html>Reactives</h3>
<div id="data" class="section level4">
<h4 class="hasAnchor"><html><body><a href="#data" class="anchor"> </a></body></html>Data</h4>
<p>The implementation to allow you to send either a dataframe or a reactive that returns a dataframe is inspired by ggvis (thanks!).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># dataset</span>
rct_data &lt;-<span class="st"> </span><span class="kw">reactive</span>({

  <span class="co"># the `data` argument can contain either:</span>
  <span class="co">#  - a reactive that returns a data frame</span>
  <span class="co">#  - a data frame </span>
  <span class="co">#</span>
  <span class="co"># in either case, we want to examine the dataframe</span>
  <span class="co">#</span>
  if (shiny::<span class="kw">is.reactive</span>(data)) {
    static_data &lt;-<span class="st"> </span><span class="kw">data</span>()
  } else {
    static_data &lt;-<span class="st"> </span>data
  }

  <span class="co"># make sure this is a data frame</span>
  shiny::<span class="kw">validate</span>(
    shiny::<span class="kw">need</span>(<span class="kw">is.data.frame</span>(static_data), <span class="st">"Cannot display graph: no data"</span>)
  )

  <span class="co"># this reactive returns the data frame</span>
  static_data
})</code></pre></div>
<p>This reactive, <code>rct_data</code>, is the <strong>only</strong> function or expression that uses the <code>data</code> argument; anything &ldquo;downstream&rdquo; will use <code>rct_data()</code>.</p>
</div>
<div id="available-variables" class="section level4">
<h4 class="hasAnchor"><html><body><a href="#available-variables" class="anchor"> </a></body></html>Available variables</h4>
<p>The inputs for this shinypod need to know what are the variables available in the dataframe - be they datetime or numeric.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># names of time variables</span>
rct_var_time &lt;-<span class="st"> </span><span class="kw">reactive</span>({

  var_time &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_names_inherits.html">df_names_inherits</a></span>(<span class="kw">rct_data</span>(), <span class="kw">c</span>(<span class="st">"POSIXct"</span>))

  shiny::<span class="kw">validate</span>(
    shiny::<span class="kw">need</span>(var_time, <span class="st">"Cannot display graph: dataset has no time variables"</span>)
  )

  var_time
})

<span class="co"># names of numeric variables</span>
rct_var_num &lt;-<span class="st"> </span><span class="kw">reactive</span>({

  var_num &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_names_inherits.html">df_names_inherits</a></span>(<span class="kw">rct_data</span>(), <span class="kw">c</span>(<span class="st">"numeric"</span>, <span class="st">"integer"</span>))

  shiny::<span class="kw">validate</span>(
    shiny::<span class="kw">need</span>(var_num, <span class="st">"Cannot display graph: dataset has no numeric variables"</span>)
  )

  var_num
})</code></pre></div>
<p>The function <code><a href="../reference/df_names_inherits.html">df_names_inherits()</a></code> returns a vector of names; these are the names of columns in the dataframe that inherit from the supplied classes.</p>
<p>We use the functions here to find what are the available time and numeric variables, so as to populate the choices for the inputs.</p>
<p>One thing to keep in mind is that if a variable is chosen for the y1 axis, it should not be available to the y2 axis. Hence, we have reactives that supply the names of the variables available to each axis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># names of variables available to y1-axis control</span>
rct_choice_y1 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
  choice_y1 &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">rct_var_num</span>(), input[[<span class="st">"y2"</span>]])

  choice_y1
})

<span class="co"># names of variables available to y2-axis control</span>
rct_choice_y2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
  choice_y2 &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">rct_var_num</span>(), input[[<span class="st">"y1"</span>]])

  choice_y2
})</code></pre></div>
</div>
<div id="dygraph" class="section level4">
<h4 class="hasAnchor"><html><body><a href="#dygraph" class="anchor"> </a></body></html>Dygraph</h4>
<p>The reactive that returns the dygraph has two main parts: validate the inputs, create a dygraph.</p>
<p>The reason we validate the inputs again is that it is possible for <code>rct_data()</code> and the axis inputs to &ldquo;get out of sync&rdquo;. This is our chance to offer a validation message, rather than an error, while the reactives and inputs catch up with each other.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># basic dygraph</span>
rct_dyg &lt;-<span class="st"> </span><span class="kw">reactive</span>({

  var_time &lt;-<span class="st"> </span>input[[<span class="st">"time"</span>]]
  var_y1 &lt;-<span class="st"> </span>input[[<span class="st">"y1"</span>]]
  var_y2 &lt;-<span class="st"> </span>input[[<span class="st">"y2"</span>]]

  shiny::<span class="kw">validate</span>(
    shiny::<span class="kw">need</span>(
      var_time %in%<span class="st"> </span><span class="kw">names</span>(<span class="kw">rct_data</span>()),
      <span class="st">"Graph cannot display without a time-variable"</span>
    ),
    shiny::<span class="kw">need</span>(
      <span class="kw">c</span>(var_y1, var_y2) %in%<span class="st"> </span><span class="kw">names</span>(<span class="kw">rct_data</span>()),
      <span class="st">"Graph cannot display without any y-variables"</span>
    )
  )

  dyg &lt;-<span class="st"> </span><span class="kw">.dygraph</span>(<span class="kw">rct_data</span>(), var_time, var_y1, var_y2)

  dyg
})</code></pre></div>
<p>The second part is to call a function that returns a dygraph, given the validated inputs. It can be useful to write such functions outside of a reactive context, so that you can build and test them interactively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># function that builds basic dygraph</span>
<span class="co"># .dygraph(wx_ames, "date", "temp", "hum")</span>
.dygraph &lt;-<span class="st"> </span>function(data, var_time, var_y1, var_y2){

  <span class="co"># create the mts object</span>
  vec_time &lt;-<span class="st"> </span>data[[var_time]]
  df_num &lt;-<span class="st"> </span>data[<span class="kw">c</span>(var_y1, var_y2)]

  <span class="co"># if no tz, use UTC</span>
  tz &lt;-<span class="st"> </span>lubridate::<span class="kw">tz</span>(vec_time)
  if (<span class="kw">identical</span>(tz, <span class="st">""</span>)) {
    tz &lt;-<span class="st"> "UTC"</span>
  }

  dy_xts &lt;-<span class="st"> </span>xts::<span class="kw">xts</span>(df_num, <span class="dt">order.by =</span> vec_time, <span class="dt">tzone =</span> tz)

  dyg &lt;-<span class="st"> </span>dygraphs::<span class="kw">dygraph</span>(dy_xts)
  dyg &lt;-<span class="st"> </span>dygraphs::<span class="kw">dyAxis</span>(dyg, <span class="st">"x"</span>, <span class="dt">label =</span> var_time)
  dyg &lt;-<span class="st"> </span>dygraphs::<span class="kw">dyAxis</span>(dyg, <span class="st">"y"</span>, <span class="dt">label =</span> <span class="kw">paste</span>(var_y1, <span class="dt">collapse =</span> <span class="st">", "</span>))
  dyg &lt;-<span class="st"> </span>dygraphs::<span class="kw">dyAxis</span>(dyg, <span class="st">"y2"</span>, <span class="dt">label =</span> <span class="kw">paste</span>(var_y2, <span class="dt">collapse =</span> <span class="st">", "</span>))

  <span class="co"># put stuff on y2 axis</span>
  for(i in <span class="kw">seq_along</span>(var_y2)) {
    dyg &lt;-<span class="st"> </span>dygraphs::<span class="kw">dySeries</span>(dyg, var_y2[i], <span class="dt">axis =</span> <span class="st">"y2"</span>)
  }

  dyg
}</code></pre></div>
</div>
</div>
<div id="observers" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#observers" class="anchor"> </a></body></html>Observers</h3>
<p>We have one observer manage the showing/hiding of inputs, depending on the availability of variables in the data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># shows and hides controls based on the availabilty and nature of data</span>
shiny::<span class="kw">observe</span>({

  has_time &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw"><a href="../reference/df_names_inherits.html">df_names_inherits</a></span>(<span class="kw">rct_data</span>(), <span class="kw">c</span>(<span class="st">"POSIXct"</span>))) &gt;<span class="st"> </span><span class="dv">0</span>
  has_num &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw"><a href="../reference/df_names_inherits.html">df_names_inherits</a></span>(<span class="kw">rct_data</span>(), <span class="kw">c</span>(<span class="st">"numeric"</span>, <span class="st">"integer"</span>)) &gt;<span class="st"> </span><span class="dv">0</span>)

  shinyjs::<span class="kw">toggle</span>(<span class="st">"time"</span>, <span class="dt">condition =</span> has_time)
  shinyjs::<span class="kw">toggle</span>(<span class="st">"y1"</span>, <span class="dt">condition =</span> has_num)
  shinyjs::<span class="kw">toggle</span>(<span class="st">"y2"</span>, <span class="dt">condition =</span> has_num)

})</code></pre></div>
<p>We have another set of observers to update the choices and selection for each of the selectInputs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># update choices for time variable</span>
shiny::<span class="kw">observeEvent</span>(
  <span class="dt">eventExpr =</span> <span class="kw">rct_var_time</span>(),
  <span class="dt">handlerExpr =</span> {
    <span class="kw">updateSelectInput</span>(
      session,
      <span class="dt">inputId =</span> <span class="st">"time"</span>,
      <span class="dt">choices =</span> <span class="kw">rct_var_time</span>(),
      <span class="dt">selected =</span> <span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(input[[<span class="st">"time"</span>]], <span class="kw">rct_var_time</span>(), <span class="dt">index =</span> <span class="dv">1</span>)
    )
  }
)</code></pre></div>
<p>The purpose of <code><a href="../reference/update_selected.html">update_selected()</a></code> is to propose a selection, given an existing value and set of choices; it takes three arguments:</p>
<ul><li><code>value</code> is the current value of the input</li>
<li><code>choices</code> are the available choices</li>
<li><code>index</code> - if <code>value</code> is not among <code>choices</code> use this index</li>
</ul><p>The first step is to determine the members of <code>value</code> that appear in <code>choices</code>. If this result is not empty, it is returned.</p>
<p>If this result is empty, then <code>index</code> is used to return that index of <code>choices</code>.</p>
<p>Some examples:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)

<span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="st">"b"</span>, <span class="dt">choices =</span> choices, <span class="dt">index =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] "b"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="st">"d"</span>, <span class="dt">choices =</span> choices, <span class="dt">index =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] "a"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="ot">NULL</span>, <span class="dt">choices =</span> choices, <span class="dt">index =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] "a"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="st">"d"</span>, <span class="dt">choices =</span> choices, <span class="dt">index =</span> <span class="ot">NULL</span>)</code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="ot">NULL</span>, <span class="dt">choices =</span> choices, <span class="dt">index =</span> <span class="ot">NULL</span>)</code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="st">"b"</span>, <span class="dt">choices =</span> <span class="ot">NULL</span>, <span class="dt">index =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/update_selected.html">update_selected</a></span>(<span class="dt">value =</span> <span class="st">"b"</span>, <span class="dt">choices =</span> <span class="ot">NULL</span>, <span class="dt">index =</span> <span class="ot">NULL</span>)</code></pre></div>
<pre><code>## NULL</code></pre>
</div>
<div id="outputs-return-value" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#outputs-return-value" class="anchor"> </a></body></html>Outputs &amp; return value</h3>
<p>One of the design choices made here was to return the dygraph as a reactive to be returned rather than as an output to be displayed.</p>
<p>This forces a little more responsibility to the user, but there can be a benefit.</p>
<p>A server function might contain lines like these:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rct_dyg &lt;-<span class="st"> </span><span class="kw">callModule</span>(dygraph_server, <span class="st">"dyg"</span>, <span class="dt">data =</span> rct_data)

output$csv_dyg &lt;-<span class="st"> </span><span class="kw">renderDygraph</span>({
  <span class="kw">rct_dyg</span>()
})</code></pre></div>
<p>If you wanted to add some customization to the dygraph, you could do so easily in the server function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output$csv_dyg &lt;-<span class="st"> </span><span class="kw">renderDygraph</span>({
  <span class="kw">rct_dyg</span>() %&gt;%
<span class="st">    </span><span class="kw">dyOptions</span>(<span class="dt">useDataTimezone =</span> <span class="ot">TRUE</span>)
})</code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#structure-of-a-server-module">Structure of a server module</a></li>
      </ul></div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ian Lyttle, Alex Shum,  Schneider Electric.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
